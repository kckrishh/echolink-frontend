<section class="flex flex-col h-full" *ngIf="clickedConvo; else emptyState">
  <!-- header  -->
  <header
    class="flex justify-between border-b border-border-base h-[6rem] flex-shrink-0"
  >
    <!-- header left side  -->
    <div
      class="px-4 flex mb-4 justify-start items-center text-text-heading h-[100%]"
    >
      <div
        class="h-14 w-14 rounded-full bg-white border border-border-base flex items-center justify-center flex-shrink-0"
      >
        <img [src]="me.avatar" class="h-full w-full rounded-full" />
      </div>

      <h3 class="px-2 text-[1.4rem]">{{ clickedConvo?.otherUsername }}</h3>
      <div class="flex items-center gap-2">
        <span
          class="h-2.5 w-2.5 rounded-full bg-brand-active shadow-echo"
        ></span>
        <span class="text-text-muted text-xs">Active now</span>
      </div>
    </div>

    <!-- header right side  -->
    <div class="text-text-body flex items-center justify-around w-[8rem] pr-14">
      <lucide-icon name="search"></lucide-icon>
      <lucide-icon name="MoreHorizontal"></lucide-icon>
    </div>
  </header>

  <!-- message area  -->
  <div class="h-full overflow-y-auto px-4 py-2" #messageContainer>
    <div class="flex flex-col min-h-full gap-3 justify-end">
      <div *ngFor="let message of messages" class="w-full">
        <!-- Row alignment -->
        <div
          class="flex w-full"
          [ngClass]="{
            'justify-end': message.senderId === me.id,
            'justify-start': message.senderId !== me.id
          }"
        >
          <!-- Avatar + bubble -->
          <div
            class="flex items-end gap-2 max-w-[85%]"
            [ngClass]="{
              'flex-row': message.senderId !== me.id,
              'flex-row-reverse': message.senderId === me.id
            }"
          >
            <!-- ✅ Avatar only for OTHER user's messages -->
            <div
              *ngIf="message.senderId !== me.id"
              class="h-8 w-8 rounded-full overflow-hidden border border-border-base flex-shrink-0"
            >
              <img
                [src]="message.senderAvatar"
                class="h-full w-full object-cover"
                alt="avatar"
              />
            </div>

            <!-- Bubble + time -->
            <div
              class="flex flex-col"
              [ngClass]="{
                'items-end': message.senderId === me.id,
                'items-start': message.senderId !== me.id
              }"
            >
              <span class="text-text-muted text-[0.7rem] mb-1">
                {{ message.createdAt | date : "shortTime" }}
              </span>

              <div
                class="px-4 py-2 rounded-2xl max-w-[70%] whitespace-pre-line break-words shadow-echo-md"
                [ngClass]="{
                  'bg-brand text-white': message.senderId === me.id,
                  'bg-bg-hover text-text-body': message.senderId !== me.id
                }"
              >
                {{ message.content }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ Message request actions (Accept / Reject) while chat is open -->
    <div class="text-center my-3" *ngIf="clickedConvo?.status === 'PENDING'">
      <span
        class="block text-text-muted text-sm bg-bg-hover px-3 py-2 rounded-xl border border-border-base"
      >
        You haven’t accepted this message request yet. Reply to start the
        conversation.
      </span>

      <div class="mt-3 flex justify-center gap-2">
        <button
          class="px-4 py-2 rounded-xl bg-brand text-white text-sm font-semibold shadow-echo"
          (click)="acceptRequest(clickedConvo)"
          type="button"
        >
          Accept
        </button>

        <button
          class="px-4 py-2 rounded-xl bg-bg-base border border-border-base text-sm font-semibold text-text-muted hover:text-text-body"
          (click)="ignoreRequest(clickedConvo)"
          type="button"
        >
          Reject
        </button>
      </div>
    </div>

    <div class="text-center my-3" *ngIf="clickedConvo?.status === 'NEUTRAL'">
      <span
        class="text-text-muted text-sm bg-bg-hover px-3 py-2 rounded-xl border border-border-base"
      >
        Say hi! This is the beginning of your conversation.
      </span>
    </div>
  </div>

  <!-- chat textbox  -->
  <div class="px-4 py-3 border-t border-border-base">
    <form (ngSubmit)="sendMessage()">
      <input
        type="text"
        placeholder="Type a message"
        class="w-full h-10 rounded-2xl bg-input-bg border border-input-border text-text-body placeholder:text-input-placeholder px-4 outline-none hover:border-input-hoverBorder focus:border-input-focusBorder focus:ring-1 focus:ring-border-focus transition duration-150 ease-out"
        name="message"
        [(ngModel)]="messageText"
      />
    </form>
  </div>
</section>

<ng-template #emptyState>
  <section class="flex flex-col h-full items-center justify-center">
    <div class="flex flex-col items-center gap-4">
      <div
        class="h-24 w-24 rounded-2xl bg-input-bg border border-border-base flex items-center justify-center shadow-echo-md"
      >
        <img src="logo.png" alt="EchoLink" class="h-16 w-16 object-contain" />
      </div>
      <h2 class="text-text-heading text-2xl font-semibold tracking-wide">
        Welcome to EchoLink
      </h2>
      <p class="text-text-muted text-sm">
        Select a conversation on the left to start messaging.
      </p>
    </div>
  </section>
</ng-template>
