<div
  *ngIf="loading"
  class="absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm"
>
  <div class="flex flex-col items-center gap-4 select-none">
    <div class="relative w-40 h-[2px] overflow-hidden bg-white/10 rounded-full">
      <span
        class="absolute inset-y-0 left-0 w-1/3 bg-white/70 rounded-full animate-loading-bar"
      ></span>
    </div>

    <span class="text-xs tracking-[0.3em] text-white/50"> ECHOLINK </span>
  </div>
</div>

<section
  *ngIf="clickedConvo; else emptyState"
  class="flex flex-col h-[82vh] md:h-[85vh] min-h-0 bg-bg-panel"
>
  <!-- header -->
  <header
    class="flex justify-between border-b border-border-base shrink-0 h-14 sm:h-16 md:h-[6rem]"
  >
    <!-- header left side -->
    <div
      class="px-3 sm:px-4 flex justify-start items-center text-text-heading h-full gap-2 sm:gap-3 min-w-0"
    >
      <button
        *ngIf="isMobile"
        type="button"
        class="mr-1 -ml-1 p-2 rounded-xl text-text-muted hover:text-text-body hover:bg-bg-hover transition"
        (click)="goBack()"
      >
        <lucide-icon name="arrow-left" class="w-5 h-5"></lucide-icon>
      </button>

      <div
        class="rounded-full bg-white border border-border-base flex items-center justify-center flex-shrink-0 h-10 w-10 sm:h-12 sm:w-12 md:h-14 md:w-14"
      >
        <img
          [src]="clickedConvo.otherUserAvatar"
          class="h-full w-full rounded-full"
        />
      </div>

      <div class="min-w-0 flex flex-col justify-center">
        <h3
          class="text-base sm:text-lg md:text-[1.4rem] leading-tight truncate"
        >
          {{ clickedConvo?.otherUsername }}
        </h3>

        <div class="flex items-center gap-2">
          <span
            class="h-2 w-2 sm:h-2.5 sm:w-2.5 rounded-full bg-brand-active shadow-echo"
          ></span>
          <span class="text-text-muted text-[0.7rem] sm:text-xs">
            Active now
          </span>
        </div>
      </div>
    </div>

    <div
      class="text-text-body flex items-center justify-end gap-3 sm:gap-4 pr-3 sm:pr-4 md:pr-14"
    >
      <lucide-icon name="search" class="w-5 h-5 md:w-6 md:h-6"></lucide-icon>
      <lucide-icon
        name="MoreHorizontal"
        class="w-5 h-5 md:w-6 md:h-6"
      ></lucide-icon>
    </div>
  </header>

  <!-- messages -->
  <div
    class="flex-1 min-h-0 overflow-y-auto px-4 py-2"
    #messageContainer
    (click)="activeReactionMessageId = null"
  >
    <div class="flex flex-col min-h-full gap-3 justify-end">
      <div *ngFor="let message of messages; let last = last" class="w-full">
        <div
          class="flex w-full"
          [ngClass]="{
            'justify-end': message.senderId === me.id,
            'justify-start': message.senderId !== me.id,
          }"
        >
          <div
            class="inline-flex items-end gap-2 max-w-[85%]"
            [ngClass]="{
              'flex-row': message.senderId !== me.id,
              'flex-row-reverse': message.senderId === me.id,
            }"
          >
            <div
              *ngIf="message.senderId !== me.id"
              class="h-8 w-8 rounded-full overflow-hidden border border-border-base flex-shrink-0"
            >
              <img
                [src]="message.senderAvatar"
                class="h-full w-full object-cover"
              />
            </div>

            <div
              class="flex flex-col"
              [ngClass]="{
                'items-end': message.senderId === me.id,
                'items-start': message.senderId !== me.id,
              }"
            >
              <span class="text-text-muted text-[0.7rem] mb-1">
                {{ message.createdAt | date: "shortTime" }}
              </span>

              <!-- ‚úÖ ONLY CHANGE IS HERE -->
              <div class="relative group w-fit max-w-full">
                <div
                  class="inline-block w-fit max-w-full px-4 py-2 rounded-2xl whitespace-pre-line break-words shadow-echo-md"
                  [ngClass]="{
                    'bg-brand text-white': message.senderId === me.id,
                    'bg-bg-hover text-text-body': message.senderId !== me.id,
                  }"
                  (pointerdown)="onMsgPressStart(message)"
                  (pointerup)="onMsgPressEnd()"
                  (pointerleave)="onMsgPressEnd()"
                >
                  {{ message.content }}
                </div>

                <button
                  type="button"
                  class="hidden md:flex absolute -top-3 h-7 w-7 items-center justify-center rounded-xl border border-border-base bg-bg-panel/90 backdrop-blur shadow-echo-md text-text-muted hover:text-text-body hover:bg-bg-hover transition opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto"
                  [ngClass]="{
                    '-right-2': message.senderId === me.id,
                    '-left-2': message.senderId !== me.id,
                  }"
                  (click)="openReactionPicker(message, $event)"
                >
                  +
                </button>

                <div
                  *ngIf="activeReactionMessageId === message.messageId"
                  class="absolute z-40 mt-2"
                  [ngClass]="{
                    'right-0': message.senderId === me.id,
                    'left-0': message.senderId !== me.id,
                  }"
                >
                  <div
                    class="flex gap-1 p-2 rounded-2xl border border-border-base bg-bg-panel shadow-echo-md"
                  >
                    <button (click)="react(message, 'LIKE', $event)">üëç</button>
                    <button (click)="react(message, 'LAUGH', $event)">
                      üòÇ
                    </button>
                    <button (click)="react(message, 'SAD', $event)">üò¢</button>
                    <button (click)="react(message, 'ANGRY', $event)">
                      üò°
                    </button>
                    <button (click)="react(message, 'FIRE', $event)">üî•</button>
                  </div>
                </div>
              </div>

              <div *ngIf="message.reactions?.length" class="mt-1 flex w-fit">
                <div class="flex gap-1">
                  <span
                    *ngFor="let r of message.reactions"
                    class="px-2 py-1 rounded-full text-sm border border-border-base bg-bg-panel"
                  >
                    {{ reactionEmoji(r.type) }}
                  </span>
                </div>
              </div>

              <div
                *ngIf="last && message.senderId === me.id"
                class="mt-1 flex justify-end"
              >
                <span class="text-sm text-text-muted">
                  {{ isMessageSeen ? "Seen" : "Sent" }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- typing indicator -->
  <div class="px-4 pb-2" *ngIf="isOtherTyping">
    <div class="flex items-center gap-2">
      <img
        [src]="clickedConvo?.otherUserAvatar"
        class="h-6 w-6 rounded-full border border-border-base"
      />
      <div
        class="px-3 py-2 rounded-2xl bg-bg-hover border border-border-base shadow-echo-md"
      >
        <div class="flex gap-1">
          <span class="typing-dot"></span>
          <span class="typing-dot typing-dot-2"></span>
          <span class="typing-dot typing-dot-3"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- composer -->
  <div class="px-4 py-3 border-t border-border-base bg-bg-panel">
    <form (ngSubmit)="sendMessage()">
      <input
        type="text"
        placeholder="Type a message"
        class="w-full h-10 rounded-2xl bg-input-bg border border-input-border px-4"
        [(ngModel)]="messageText"
        name="message"
        (input)="onTyping()"
      />
    </form>
  </div>
</section>

<ng-template #emptyState>
  <section class="flex flex-col h-[100dvh] min-h-0 items-center justify-center">
    <div class="flex flex-col items-center gap-4">
      <div
        class="h-24 w-24 rounded-2xl bg-input-bg border border-border-base flex items-center justify-center shadow-echo-md"
      >
        <img src="logo.png" alt="EchoLink" class="h-16 w-16 object-contain" />
      </div>
      <h2 class="text-text-heading text-2xl font-semibold tracking-wide">
        Welcome to EchoLink
      </h2>
      <p class="text-text-muted text-sm">
        Select a conversation on the left to start messaging.
      </p>
    </div>
  </section>
</ng-template>
